<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planilha Dinâmica de Cabos</title>
    <!-- Carregamento do Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilo customizado para usar a fonte Inter e garantir um fundo agradável */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .card {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 0 10px -5px rgba(0, 0, 0, 0.04);
        }
        .table-sticky-header thead th {
            position: sticky;
            top: 0;
            background-color: #f3f4f6;
            z-index: 10;
        }
    </style>
</head>
<body class="p-4 flex flex-col items-center justify-start min-h-screen">

    <div class="card w-full max-w-4xl bg-white p-6 md:p-8 rounded-xl border border-gray-200 mb-8">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-6 text-center">
            Planilha de Planejamento de Cabos
        </h1>
        <p class="text-gray-500 mb-6 text-center">
            Insira os detalhes de cada trecho de cabeamento e adicione à planilha.
        </p>

        <!-- Formulário de Entrada para Nova Linha -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end mb-6 border p-4 rounded-lg bg-gray-50">
            <!-- Descrição -->
            <div class="md:col-span-1">
                <label for="cableDescription" class="block text-sm font-medium text-gray-700 mb-1">
                    Descrição do Cabo
                </label>
                <input type="text" id="cableDescription"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                       placeholder="Ex: Fase Ar Condicionado">
            </div>

            <!-- Quantidade -->
            <div class="md:col-span-1">
                <label for="numCables" class="block text-sm font-medium text-gray-700 mb-1">
                    Quantidade (un.)
                </label>
                <input type="number" id="numCables" min="1" value="1"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                       placeholder="5">
            </div>

            <!-- Comprimento Unitário -->
            <div class="md:col-span-1">
                <label for="cableLength" class="block text-sm font-medium text-gray-700 mb-1">
                    Comprimento Unitário (m)
                </label>
                <input type="number" id="cableLength" min="0.1" step="0.1" value="10"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                       placeholder="10.5">
            </div>

            <!-- Botão Adicionar -->
            <div class="md:col-span-1">
                <button onclick="addCableRun()"
                        class="w-full bg-blue-600 text-white py-2.5 rounded-lg font-semibold hover:bg-blue-700 transition duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    Adicionar à Tabela
                </button>
            </div>
        </div>

        <!-- Tabela de Resultados Dinâmica -->
        <h2 class="text-xl font-bold text-gray-800 mb-4 pt-4 border-t border-gray-200">
            Planilha Detalhada (Margem de 30%)
        </h2>

        <div class="overflow-x-auto rounded-lg shadow-md border border-gray-200 table-sticky-header">
            <table class="w-full text-sm text-left text-gray-500">
                <!-- Cabeçalho da Tabela -->
                <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                    <tr>
                        <th scope="col" class="px-3 py-3 w-4/12">
                            Descrição
                        </th>
                        <th scope="col" class="px-3 py-3 w-1/12 text-center">
                            Qtd.
                        </th>
                        <th scope="col" class="px-3 py-3 w-2/12 text-right">
                            Unitário (m)
                        </th>
                        <th scope="col" class="px-3 py-3 w-2/12 text-right">
                            Total (100%)
                        </th>
                        <th scope="col" class="px-3 py-3 w-2/12 text-right text-green-700">
                            Com Sobra (+30%)
                        </th>
                        <th scope="col" class="px-3 py-3 w-1/12 text-center">
                            Ação
                        </th>
                    </tr>
                </thead>
                <!-- Corpo da Tabela (Preenchido pelo JavaScript) -->
                <tbody id="cableTableBody">
                    <!-- Linhas serão inseridas aqui -->
                    <tr id="emptyRowPlaceholder" class="bg-white border-b">
                        <td colspan="6" class="px-6 py-4 text-center text-gray-500 italic">
                            Nenhum item adicionado ainda. Use o formulário acima.
                        </td>
                    </tr>
                </tbody>
                <!-- Rodapé/Totalizador -->
                <tfoot class="bg-gray-200 text-gray-900 font-extrabold border-t-2 border-blue-500">
                    <tr>
                        <!-- Célula do Total Geral -->
                        <td colspan="4" class="px-6 py-3 text-right text-base">
                            TOTAL GERAL NECESSÁRIO (com 30% de sobra)
                        </td>
                        <td class="px-6 py-3 text-right text-lg text-green-700" id="grandTotalMargin">
                            0,00 metros
                        </td>
                        <!-- Célula de Ações (Exportar + Limpar) -->
                        <td class="px-6 py-3 bg-gray-100 text-center space-y-1">
                            <button id="exportButton" onclick="exportToCSV()" class="w-full bg-indigo-600 text-white py-1 rounded-md font-semibold text-xs hover:bg-indigo-700 transition duration-150">
                                Exportar para CSV
                            </button>
                            <button onclick="clearAll()" class="w-full text-red-600 hover:text-red-800 font-semibold text-xs transition duration-150 py-1">
                                Limpar Planilha
                            </button>
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <p class="text-xs text-gray-500 pt-3 text-center">
            *A margem de 30% é aplicada individualmente a cada trecho.
        </p>
    </div>

    <script>
        let cableRuns = []; // Array que armazena todos os trechos de cabos

        // Função utilitária para formatar números
        function formatNumber(num, decimals = 2) {
            if (isNaN(num)) return '0,00';
            const roundedNum = Math.round(num * 100) / 100;
            return roundedNum.toLocaleString('pt-BR', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
        }

        // 1. Adiciona um novo trecho de cabo à lista
        function addCableRun() {
            const descriptionInput = document.getElementById('cableDescription');
            const numCablesInput = document.getElementById('numCables');
            const cableLengthInput = document.getElementById('cableLength');

            const description = descriptionInput.value.trim() || 'Sem descrição';
            const numCables = parseInt(numCablesInput.value) || 0;
            const cableLength = parseFloat(cableLengthInput.value) || 0;

            if (numCables <= 0 || cableLength <= 0) {
                // Indicação visual de erro
                const originalPlaceholder = descriptionInput.placeholder;
                descriptionInput.placeholder = 'Preencha Qtd e Unitário!';
                descriptionInput.classList.add('border-red-500');
                setTimeout(() => {
                    descriptionInput.placeholder = originalPlaceholder;
                    descriptionInput.classList.remove('border-red-500');
                }, 2000);
                return;
            }

            // Cálculo
            const totalLength = numCables * cableLength;
            const safetyMargin = 0.30;
            const totalWithMargin = totalLength * (1 + safetyMargin);
            
            // Cria o objeto do novo trecho
            const newRun = {
                id: Date.now(), // ID único para remoção
                description,
                numCables,
                cableLength,
                totalLength,
                totalWithMargin
            };

            // Adiciona ao array e renderiza
            cableRuns.push(newRun);
            renderTable();

            // Limpa os campos para nova entrada
            descriptionInput.value = '';
            numCablesInput.value = '';
            cableLengthInput.value = '';
            descriptionInput.focus();
        }
        
        // 2. Remove um trecho de cabo pelo ID
        function removeCableRun(id) {
            cableRuns = cableRuns.filter(run => run.id !== id);
            renderTable();
        }

        // 3. Limpa todos os dados da tabela
        function clearAll() {
            if (cableRuns.length > 0) {
                // Ação direta, sem confirm() que é proibido.
                console.log("Planilha limpa pelo usuário.");
                cableRuns = [];
                renderTable();
            }
        }

        // 4. Renderiza toda a tabela e calcula o total geral
        function renderTable() {
            const tableBody = document.getElementById('cableTableBody');
            const grandTotalDisplay = document.getElementById('grandTotalMargin');
            let grandTotalWithMargin = 0;
            let tableHTML = '';
            
            if (cableRuns.length === 0) {
                // Se não há itens, mostra o placeholder
                tableHTML = `<tr id="emptyRowPlaceholder" class="bg-white border-b">
                    <td colspan="6" class="px-6 py-4 text-center text-gray-500 italic">
                        Nenhum item adicionado ainda. Use o formulário acima.
                    </td>
                </tr>`;
            } else {
                // Itera sobre todos os trechos de cabos e constrói as linhas
                cableRuns.forEach(run => {
                    grandTotalWithMargin += run.totalWithMargin;

                    tableHTML += `
                        <tr class="bg-white border-b hover:bg-gray-50">
                            <td class="px-3 py-2 font-medium text-gray-900 truncate">${run.description}</td>
                            <td class="px-3 py-2 text-center">${run.numCables}</td>
                            <td class="px-3 py-2 text-right">${formatNumber(run.cableLength)}</td>
                            <td class="px-3 py-2 text-right font-semibold">${formatNumber(run.totalLength)} m</td>
                            <td class="px-3 py-2 text-right text-green-700 font-bold">${formatNumber(run.totalWithMargin)} m</td>
                            <td class="px-3 py-2 text-center">
                                <button onclick="removeCableRun(${run.id})" class="text-red-500 hover:text-red-700 font-medium text-xs">
                                    Remover
                                </button>
                            </td>
                        </tr>
                    `;
                });
            }

            // Atualiza o corpo da tabela
            tableBody.innerHTML = tableHTML;
            
            // Atualiza o total geral
            grandTotalDisplay.textContent = formatNumber(grandTotalWithMargin) + ' metros';
        }

        // 5. Função para Exportar para CSV (Excel)
        function exportToCSV() {
            const exportButton = document.getElementById('exportButton');
            
            if (cableRuns.length === 0) {
                // Feedback visual simples
                const originalText = exportButton.textContent;
                exportButton.textContent = 'Adicione itens primeiro!';
                exportButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                exportButton.classList.add('bg-red-500', 'hover:bg-red-600');
                setTimeout(() => {
                    exportButton.textContent = originalText;
                    exportButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                    exportButton.classList.remove('bg-red-500', 'hover:bg-red-600');
                }, 3000);
                return;
            }

            // Define os cabeçalhos do CSV
            const headers = [
                "ID",
                "Descrição do Cabo",
                "Quantidade (un.)",
                "Comprimento Unitário (m)",
                "Comprimento Total (100%)",
                "Comprimento com Sobra (+30%)"
            ];

            // Mapeia os dados. Usamos ponto-e-vírgula (;) como separador para melhor compatibilidade com Excel em PT-BR.
            const csvRows = cableRuns.map(run => {
                return [
                    run.id,
                    `"${run.description.replace(/"/g, '""')}"`, // Trata aspas dentro da descrição
                    run.numCables.toFixed(0),
                    // Converte ponto decimal para vírgula para PT-BR Excel
                    run.cableLength.toFixed(2).replace('.', ','), 
                    run.totalLength.toFixed(2).replace('.', ','),
                    run.totalWithMargin.toFixed(2).replace('.', ',')
                ].join(';'); // Junta os campos com ponto e vírgula
            });

            // Concatena cabeçalhos e linhas
            const csvContent = [
                headers.join(';'),
                ...csvRows
            ].join('\n');

            // Cria o Blob e dispara o download
            // Adiciona BOM (Byte Order Mark) para garantir que caracteres especiais (acentos) funcionem no Excel
            const bom = '\ufeff'; 
            const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'planilha_cabos_' + new Date().toISOString().slice(0, 10) + '.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url); // Libera o objeto URL
        }

        // Inicia a renderização ao carregar a página
        window.onload = function() {
            renderTable();
        };
    </script>
</body>
</html>
